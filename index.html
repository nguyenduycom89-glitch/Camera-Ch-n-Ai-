<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i T∆∞∆°ng T√°c AI & √în T·∫≠p Tr·∫Øc Nghi·ªám</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { overflow: hidden; background: linear-gradient(to bottom, #87CEEB 53%, #6B9E34 53%); height: 100vh; width: 100vw; position: relative;}
        
        .sun { position: absolute; top: 40px; left: 40px; width: 120px; height: 120px; background-color: #FFD700; border-radius: 50%; box-shadow: 0 0 40px #FF8C00; cursor: pointer; transition: 0.2s; z-index: 100;}
        .sun:hover { transform: scale(1.1); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; position: relative; z-index: 100; }
        
        /* C·ª•m n√∫t ƒëi·ªÅu khi·ªÉn ch√≠nh */
        .controls { display: flex; gap: 15px; align-items: center;}
        .btn-icon { background: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.2s; display: flex; justify-content: center; align-items: center; }
        .btn-icon:hover { transform: scale(1.1); background: #f0f0f0; }
        
        .btn-feature { background: #FF6347; color: white; border: none; padding: 12px 25px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: 0.2s; display: flex; align-items: center; gap: 8px;}
        .btn-feature:hover { transform: scale(1.05); background: #FF4500; }

        .status-badge { background-color: #4682B4; color: #FFD700; padding: 12px 35px; border-radius: 30px; font-size: 22px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.3s; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã h·ªçc sinh bay l∆∞·ª£n */
        #game-area { position: absolute; top: 100px; left: 0; width: 100vw; height: calc(100vh - 100px); overflow: hidden; }
        .student-node { position: absolute; display: flex; flex-direction: column; align-items: center; width: 100px; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s; z-index: 10; cursor: pointer; }
        .student-node img { width: 75px; height: 75px; background-color: rgba(255,255,255,0.9); border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3); pointer-events: none; }
        .student-node .name { background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 12px; font-size: 14px; font-weight: bold; margin-top: 5px; text-align: center; white-space: nowrap; pointer-events: none; }
        
        .student-node.selected { z-index: 999 !important; }
        .student-node.selected img { border-color: #FFD700; background-color: #fff; box-shadow: 0 0 40px #FFD700; transform: scale(1.2); transition: 0.3s;}
        .student-node.selected .name { background: #FFD700; color: #000; font-size: 18px; transform: scale(1.2); transition: 0.3s; margin-top: 15px;}

        /* Camera AI */
        .camera-container { position: absolute; bottom: 40px; right: 20px; width: 260px; height: 195px; background: black; border: 4px solid white; border-radius: 12px; overflow: hidden; z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #webcam, #output_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .ai-status { position: absolute; bottom: 5px; right: 10px; color: #00FF00; font-size: 14px; font-weight: bold; text-shadow: 2px 2px 4px black; z-index: 1001;}

        /* Modal D√πng chung (C√†i ƒë·∫∑t, C√¢u h·ªèi) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);}
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 750px; max-width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 15px 30px rgba(0,0,0,0.5); position: relative;}
        .modal h2 { margin-bottom: 15px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; text-align: center; font-size: 24px;}
        
        /* Giao di·ªán C√¢u H·ªèi Tr·∫Øc Nghi·ªám */
        #question-display { font-size: 22px; font-weight: bold; color: #1E90FF; margin-bottom: 25px; text-align: center; line-height: 1.5;}
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option-btn { background: #fff; border: 2px solid #ced4da; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: left; color: #495057; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .option-btn:hover { background: #f8f9fa; border-color: #adb5bd; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);}
        .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);}
        
        /* Form C√†i ƒë·∫∑t */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: bold; color: #444; font-size: 15px;}
        .form-group textarea { width: 100%; height: 160px; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-family: monospace; font-size: 14px; resize: vertical;}
        .file-upload-wrapper { background: #f0f8ff; padding: 10px 15px; border-radius: 8px; border: 1px dashed #4682B4; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px;}
        .file-upload-wrapper input { font-size: 13px; }
        
        .btn-save { background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; float: right; margin-left: 10px;}
        .btn-close { background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; float: right; }
        .close-x { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #aaa; transition: 0.2s;}
        .close-x:hover { color: #f44336; }

        /* Ch·ªØ k√Ω ch√¢n trang */
        .footer-credit { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: rgba(255, 255, 255, 0.85); font-size: 15px; font-style: italic; z-index: 100; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); pointer-events: none; font-weight: 500;}

        /* Logo Canva g√≥c tr√°i d∆∞·ªõi xoay v√≤ng */
        .canva-logo-spin {
            position: absolute;
            bottom: 25px;
            left: 25px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #00C4CC, #8A2BE2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 900;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            z-index: 1005;
            animation: spin 6s linear infinite;
            border: 2px solid rgba(255, 255, 255, 0.8);
            user-select: none;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- TH·∫∫ AUDIO -->
    <audio id="bgMusic" loop preload="auto"><source src="nhacnen.mp3" type="audio/mpeg"></audio>
    <audio id="correctSound" preload="auto"></audio>
    <audio id="wrongSound" preload="auto"></audio>

    <div class="sun" onclick="triggerSelection(1)" title="B·∫•m v√†o ƒë√¢y ƒë·ªÉ g·ªçi ng·∫´u nhi√™n 1 em"></div>
    
    <div class="header">
        <div class="controls">
            <button class="btn-icon" onclick="openSettings()" title="C√†i ƒë·∫∑t (H·ªçc sinh, C√¢u h·ªèi, Nh·∫°c)">‚öôÔ∏è</button>
            <button class="btn-icon" onclick="resetStudents()" title="L√†m m·ªõi l·∫°i to√†n b·ªô danh s√°ch l·ªõp">üîÑ</button>
            <button class="btn-icon" id="musicBtn" onclick="toggleMusic()" title="B·∫≠t/T·∫Øt nh·∫°c n·ªÅn">üîá</button>
            <button class="btn-feature" style="background: #20b2aa;" onclick="showRandomQuestion()">üìù √în T·∫≠p Tr·∫Øc Nghi·ªám</button>
        </div>
        <div class="status-badge" id="statusText">Gi∆° ng√≥n tay v√†o Camera ƒë·ªÉ ch·ªçn h·ªçc sinh!</div>
        <div style="flex: 1;"></div>
    </div>

    <div id="game-area"></div>

    <div class="camera-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
        <div class="ai-status" id="ai-status">ƒêang t·∫£i AI...</div>
    </div>

    <!-- Logo Canva xoay v√≤ng -->
    <div class="canva-logo-spin">Canva</div>

    <div class="footer-credit"><i>"·ª®ng d·ª•ng ƒë∆∞·ª£c thi·∫øt k·∫ø tr√™n n·ªÅn t·∫£ng Gemini/Canva" ƒë∆∞·ª£c t·∫°o b·ªüi th·∫ßy Nguy·ªÖn ƒê·ª©c Duy</i></div>

    <!-- MODAL C√ÄI ƒê·∫∂T -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-x" onclick="closeModal('settingsModal')">‚úñ</span>
            <h2>C√†i ƒë·∫∑t Tr√≤ ch∆°i & D·ªØ li·ªáu</h2>
            
            <div style="display: flex; gap: 20px;">
                <!-- C·ªôt tr√°i: H·ªçc sinh & √Çm thanh -->
                <div style="flex: 1;">
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #fafafa;">
                        <h3 style="font-size: 15px; margin-bottom: 10px; color: #555;">üéµ C√†i ƒë·∫∑t √Çm thanh</h3>
                        <div class="file-upload-wrapper">
                            <label>Nh·∫°c n·ªÅn (Ch·∫°y xuy√™n su·ªët):</label>
                            <input type="file" id="musicUpload" accept="audio/*">
                        </div>
                        <div class="file-upload-wrapper">
                            <label>‚úîÔ∏è √Çm thanh b√°o ƒê√öNG:</label>
                            <input type="file" id="correctUpload" accept="audio/*">
                        </div>
                        <div class="file-upload-wrapper">
                            <label>‚ùå √Çm thanh b√°o SAI:</label>
                            <input type="file" id="wrongUpload" accept="audio/*">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üìã Danh s√°ch H·ªçc sinh (T√™n | T√™nFile·∫¢nh):</label>
                        <p style="font-size: 12px; color: #666; margin-bottom: 5px;">- Ch·ªâ g√µ t√™n: AI t·ª± v·∫Ω ·∫£nh.<br>- G√µ T√™n|T√™nFile·∫¢nh: D√πng ·∫£nh th·∫≠t.</p>
                        <textarea id="studentsDataText" placeholder="T√πng Chi|Chi.png.png&#10;B·∫£o Ng·ªçc|Bngoc.png.png"></textarea>
                    </div>
                </div>

                <!-- C·ªôt ph·∫£i: Ng√¢n h√†ng c√¢u h·ªèi -->
                <div style="flex: 1;">
                    <div class="form-group">
                        <label>üìö Ng√¢n h√†ng C√¢u h·ªèi Tr·∫Øc nghi·ªám:</label>
                        <p style="font-size: 12px; color: #d32f2f; margin-bottom: 5px;">*Copy d√°n theo ƒë√∫ng c·∫•u tr√∫c m·∫´u b√™n d∆∞·ªõi (Vi·∫øt hoa A,B,C,D v√† ƒê√°p √°n).</p>
                        <textarea id="questionsDataText" style="height: 480px; background: #fffdf2;"></textarea>
                    </div>
                </div>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn-save" onclick="saveSettings()">üíæ L∆∞u & √Åp D·ª•ng</button>
                <button class="btn-close" onclick="closeModal('settingsModal')">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- MODAL C√ÇU H·ªéI TR·∫ÆC NGHI·ªÜM -->
    <div class="modal" id="questionModal">
        <div class="modal-content" style="width: 800px; padding: 40px;">
            <span class="close-x" onclick="closeModal('questionModal')">‚úñ</span>
            <h2 style="color: #4682B4; font-size: 28px; margin-bottom: 25px;">Ph·∫ßn Thi Tr·∫Øc Nghi·ªám</h2>
            <div id="question-display">ƒêang t·∫£i c√¢u h·ªèi...</div>
            <div class="options-grid" id="options-container">
                <!-- N√∫t ƒë√°p √°n t·ª± sinh ra -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-feature" style="display: inline-flex; margin: 0 auto; background: #20b2aa; padding: 15px 30px; font-size: 20px;" onclick="showRandomQuestion()">Chuy·ªÉn C√¢u Kh√°c ‚è≠</button>
            </div>
        </div>
    </div>

    <script>
        // --- QU·∫¢N L√ù MODAL ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- QU·∫¢N L√ù √ÇM THANH (NH·∫†C N·ªÄN & HI·ªÜU ·ª®NG) ---
        const bgMusic = document.getElementById('bgMusic');
        const correctSound = document.getElementById('correctSound');
        const wrongSound = document.getElementById('wrongSound');
        const musicBtn = document.getElementById('musicBtn');
        let isMusicPlaying = false;

        document.getElementById('musicUpload').addEventListener('change', function(event) {
            if (event.target.files[0]) bgMusic.src = URL.createObjectURL(event.target.files[0]);
        });
        document.getElementById('correctUpload').addEventListener('change', function(event) {
            if (event.target.files[0]) correctSound.src = URL.createObjectURL(event.target.files[0]);
        });
        document.getElementById('wrongUpload').addEventListener('change', function(event) {
            if (event.target.files[0]) wrongSound.src = URL.createObjectURL(event.target.files[0]);
        });

        function toggleMusic() {
            if (isMusicPlaying) { bgMusic.pause(); musicBtn.innerText = 'üîá'; } 
            else {
                bgMusic.play().then(() => { musicBtn.innerText = 'üîä'; })
                .catch(() => { alert("Ch∆∞a c√≥ nh·∫°c n·ªÅn! H√£y v√†o C√†i ƒë·∫∑t (‚öôÔ∏è) t·∫£i nh·∫°c n·ªÅn l√™n nh√©."); isMusicPlaying = false; });
            }
            isMusicPlaying = !isMusicPlaying;
        }

        // --- H·ªÜ TH·ªêNG C√ÇU H·ªéI TR·∫ÆC NGHI·ªÜM ---
        const defaultQuestions = `C√¢u 1: S·ªë g·ªìm 5 trƒÉm ngh√¨n, 3 ch·ª•c ngh√¨n, 2 ƒë∆°n v·ªã vi·∫øt l√† g√¨? (To√°n 4)
A. 503 002
B. 530 002
C. 53 002
D. 500 302
ƒê√°p √°n: B

C√¢u 2: T·ª´ n√†o sau ƒë√¢y l√† t·ª´ l√°y? (Ti·∫øng Vi·ªát 4)
A. S√°ch v·ªü
B. Xe ƒë·∫°p
C. M√°t m·∫ª
D. Hoa h·ªìng
ƒê√°p √°n: C

C√¢u 3: Qu√° tr√¨nh th·ª±c v·∫≠t t·ª± t·∫°o ra ch·∫•t dinh d∆∞·ª°ng g·ªçi l√† g√¨? (Khoa h·ªçc 4)
A. H√¥ h·∫•p
B. Tho√°t h∆°i n∆∞·ªõc
C. B√†i ti·∫øt
D. Quang h·ª£p
ƒê√°p √°n: D`;

        let questionBank = [];
        let currentCorrectAnswer = "";

        function parseQuestions(text) {
            let parsedList = [];
            let blocks = text.split(/\n\s*\n/); 
            blocks.forEach(block => {
                let lines = block.split('\n').filter(l => l.trim() !== '');
                if(lines.length >= 6) {
                    let q = lines[0]; 
                    let opts = [lines[1], lines[2], lines[3], lines[4]]; 
                    let ansLine = lines[5].toUpperCase();
                    let ans = "A";
                    if(ansLine.includes("B")) ans = "B";
                    if(ansLine.includes("C")) ans = "C";
                    if(ansLine.includes("D")) ans = "D";
                    parsedList.push({ question: q, options: opts, answer: ans });
                }
            });
            return parsedList;
        }

        function showRandomQuestion() {
            if(questionBank.length === 0) {
                alert("Ng√¢n h√†ng c√¢u h·ªèi tr·ªëng! Vui l√≤ng v√†o C√†i ƒë·∫∑t ƒë·ªÉ th√™m c√¢u h·ªèi.");
                return;
            }
            let randomIndex = Math.floor(Math.random() * questionBank.length);
            let qData = questionBank[randomIndex];
            currentCorrectAnswer = qData.answer;

            document.getElementById('question-display').innerText = qData.question;
            let optionsHtml = '';
            
            const labels = ['A', 'B', 'C', 'D'];
            qData.options.forEach((optText, index) => {
                let label = labels[index];
                optionsHtml += `<button class="option-btn" onclick="checkAnswer(this, '${label}')"><b>${label}.</b> ${optText.replace(/^[A-D]\.\s*/, '')}</button>`;
            });

            document.getElementById('options-container').innerHTML = optionsHtml;
            document.getElementById('questionModal').style.display = 'flex';
        }

        function checkAnswer(btnElement, selectedOption) {
            let allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(btn => btn.disabled = true);

            if(selectedOption === currentCorrectAnswer) {
                btnElement.classList.add('correct');
                correctSound.currentTime = 0; 
                correctSound.play().catch(e => console.log("Ch∆∞a t·∫£i √¢m thanh ƒë√∫ng"));
            } else {
                btnElement.classList.add('wrong');
                wrongSound.currentTime = 0;
                wrongSound.play().catch(e => console.log("Ch∆∞a t·∫£i √¢m thanh sai"));
                
                let correctIndex = ['A', 'B', 'C', 'D'].indexOf(currentCorrectAnswer);
                if(correctIndex >= 0 && correctIndex < allBtns.length) {
                    allBtns[correctIndex].classList.add('correct');
                }
            }
        }

        // --- D·ªÆ LI·ªÜU H·ªåC SINH V√Ä C√ÄI ƒê·∫∂T ---
        const defaultStudents = ["T√πng Chi|Chi.png.png", "B·∫£o Ng·ªçc|Bngoc.png.png", "B·∫£o Tr√¢n|BTran.png.png", "Gia B·∫£o", "Minh Khang", "Tu·∫•n Ki·ªát"];
        let students = [], studentNodes = [], isAnimating = true, isSelecting = false; 
        
        function loadSettings() {
            const savedData = localStorage.getItem('classDataNamesOnly');
            const rawData = savedData ? savedData : defaultStudents.join('\n');
            students = rawData.split('\n').filter(line => line.trim() !== '').map(line => {
                let parts = line.split('|');
                let cleanName = parts[0].trim();
                let imgUrl = parts[1] ? parts[1].trim() : `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(cleanName)}`;
                return { name: cleanName, img: imgUrl };
            });
            document.getElementById('studentsDataText').value = rawData;

            const savedQuestions = localStorage.getItem('questionBankData');
            const rawQuestions = savedQuestions ? savedQuestions : defaultQuestions;
            document.getElementById('questionsDataText').value = rawQuestions;
            questionBank = parseQuestions(rawQuestions);

            initGameArea();
        }

        function saveSettings() {
            localStorage.setItem('classDataNamesOnly', document.getElementById('studentsDataText').value);
            localStorage.setItem('questionBankData', document.getElementById('questionsDataText').value);
            
            closeModal('settingsModal');
            loadSettings(); 
        }

        // --- L√ÄM M·ªöI L·∫†I L·ªöP (N√∫t üîÑ) ---
        function resetStudents() {
            isSelecting = false;
            lastFingerCount = 0;
            document.getElementById('statusText').innerText = "Gi∆° ng√≥n tay v√†o Camera ƒë·ªÉ ch·ªçn h·ªçc sinh!";
            document.getElementById('statusText').style.backgroundColor = "#4682B4";
            initGameArea();
        }

        // --- KHU V·ª∞C TR√í CH∆†I & CHUY·ªÇN ƒê·ªòNG ---
        const gameArea = document.getElementById('game-area');
        
        function initGameArea() {
            gameArea.innerHTML = '';
            studentNodes = [];
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;

            students.forEach((std) => {
                let el = document.createElement('div');
                el.className = 'student-node';
                el.innerHTML = `<img src="${std.img}" alt="HS" onerror="this.src='https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(std.name)}'"><div class="name">${std.name}</div>`;
                gameArea.appendChild(el);

                let speedX = (Math.random() - 0.5) * 5;
                let speedY = (Math.random() - 0.5) * 5;
                if(Math.abs(speedX) < 1.5) speedX = speedX < 0 ? -1.5 : 1.5;
                if(Math.abs(speedY) < 1.5) speedY = speedY < 0 ? -1.5 : 1.5;

                let nodeObj = {
                    element: el, x: Math.random() * (areaWidth - 100), y: Math.random() * (areaHeight - 100),
                    vx: speedX, vy: speedY, wobble: Math.random() * Math.PI * 2, selected: false
                };
                studentNodes.push(nodeObj);
            });
            if(!document.animationStarted) {
                requestAnimationFrame(animateStudents);
                document.animationStarted = true;
            }
        }

        function animateStudents() {
            if(!isAnimating) return;
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;

            studentNodes.forEach(node => {
                if(!node.selected) {
                    node.x += node.vx; node.y += node.vy; node.wobble += 0.08;
                    if(node.x <= 0 || node.x >= areaWidth - 100) node.vx *= -1;
                    if(node.y <= 0 || node.y >= areaHeight - 100) node.vy *= -1;
                    let rotationAngle = Math.sin(node.wobble) * 10; 
                    node.element.style.transform = `translate(${node.x}px, ${node.y}px) rotate(${rotationAngle}deg) scale(1)`;
                }
            });
            requestAnimationFrame(animateStudents);
        }

        // --- CAMERA V√Ä NH·∫¨N DI·ªÜN AI ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('statusText');
        const aiStatus = document.getElementById('ai-status');

        let stableFrames = 0;
        let lastFingerCount = 0;

        function countFingers(landmarks) {
            let count = 0;
            if (landmarks[8].y < landmarks[6].y) count++;  
            if (landmarks[12].y < landmarks[10].y) count++; 
            if (landmarks[16].y < landmarks[14].y) count++; 
            if (landmarks[20].y < landmarks[18].y) count++; 
            let thumbTipDist = Math.abs(landmarks[4].x - landmarks[9].x);
            let thumbBaseDist = Math.abs(landmarks[3].x - landmarks[9].x);
            if (thumbTipDist > thumbBaseDist + 0.03 && landmarks[4].y < landmarks[0].y) count++; 
            return count;
        }

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (isSelecting) {
                aiStatus.innerText = "ƒêang kh√≥a AI hi·ªÉn th·ªã...";
                canvasCtx.restore();
                return;
            }

            // N·∫øu h·∫øt h·ªçc sinh th√¨ kh√¥ng nh·∫≠n di·ªán tay n·ªØa
            if (studentNodes.length === 0) {
                aiStatus.innerText = "ƒê√£ g·ªçi h·∫øt l·ªõp!";
                canvasCtx.restore();
                return;
            }

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                let landmarks = results.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

                let fingerCount = countFingers(landmarks);
                aiStatus.innerText = `ƒêang gi∆°: ${fingerCount} ng√≥n`;

                let targetCount = Math.min(fingerCount, studentNodes.length);

                if(targetCount > 0 && targetCount <= 5) {
                    if(fingerCount === lastFingerCount) {
                        stableFrames++;
                        if(stableFrames === 20) { 
                            triggerSelection(targetCount);
                            stableFrames = 0;
                        }
                    } else {
                        lastFingerCount = fingerCount;
                        stableFrames = 0;
                    }
                } else {
                    stableFrames = 0;
                }
            } else {
                aiStatus.innerText = "AI S·∫µn s√†ng! (Ch∆∞a th·∫•y tay)";
                stableFrames = 0;
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 320, height: 240
        });
        camera.start();

        // --- LOGIC G·ªåI T√äN & LO·∫†I D·∫¶N H·ªåC SINH ---
        function triggerSelection(count) {
            if (isSelecting) return; // Kh√≥a l·ªánh n·∫øu ƒëang hi·ªÉn th·ªã h·ªçc sinh, tr√°nh b·∫•m ƒë√∫p
            if (studentNodes.length === 0) {
                alert("ƒê√£ g·ªçi h·∫øt danh s√°ch l·ªõp! Vui l√≤ng b·∫•m n√∫t üîÑ (L√†m m·ªõi) ·ªü g√≥c tr√°i ƒë·ªÉ ch∆°i l·∫°i t·ª´ ƒë·∫ßu.");
                return;
            }

            // ƒê·∫£m b·∫£o kh√¥ng g·ªçi s·ªë l∆∞·ª£ng l·ªõn h∆°n s·ªë h·ªçc sinh c√≤n l·∫°i tr√™n m√†n h√¨nh
            count = Math.min(count, studentNodes.length);

            isSelecting = true; 
            statusText.innerText = `ƒê√£ ch·ªçn ${count} h·ªçc sinh l√™n tr·∫£ l·ªùi!`;
            statusText.style.backgroundColor = "#FF4500";
            
            studentNodes.forEach(node => {
                node.selected = false;
                node.element.classList.remove('selected');
            });

            let shuffled = [...studentNodes].sort(() => 0.5 - Math.random());
            let selectedNodes = shuffled.slice(0, count);

            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;
            const startX = (areaWidth - (count * 150)) / 2; 

            selectedNodes.forEach((node, index) => {
                node.selected = true;
                node.element.classList.add('selected');
                node.x = startX + (index * 150);
                node.y = areaHeight / 2 - 80;
                node.element.style.transform = `translate(${node.x}px, ${node.y}px) rotate(0deg)`;
            });

            setTimeout(() => {
                selectedNodes.forEach(node => {
                    node.element.style.opacity = '0';
                    node.element.style.transform = `translate(${node.x}px, ${node.y}px) scale(0)`;
                    
                    setTimeout(() => {
                        if(node.element.parentNode) {
                            node.element.parentNode.removeChild(node.element);
                        }
                    }, 500);

                    studentNodes = studentNodes.filter(n => n !== node);
                });

                if (studentNodes.length === 0) {
                    statusText.innerText = "ƒê√£ g·ªçi h·∫øt l·ªõp! B·∫•m n√∫t üîÑ ƒë·ªÉ ch∆°i l·∫°i.";
                    statusText.style.backgroundColor = "#28a745"; 
                } else {
                    statusText.innerText = "Gi∆° ng√≥n tay v√†o Camera ƒë·ªÉ ti·∫øp t·ª•c ch·ªçn!";
                    statusText.style.backgroundColor = "#4682B4";
                }
                
                setTimeout(() => { isSelecting = false; lastFingerCount = 0; }, 500);
            }, 8000); 
        }

        window.onload = loadSettings;
    </script>
</body>
</html>
